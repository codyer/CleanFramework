package com.cody.app.business.customer;import android.databinding.DataBindingUtil;import android.os.Bundle;import android.support.design.widget.TabLayout;import android.support.v7.widget.RecyclerView;import android.view.LayoutInflater;import android.view.View;import android.widget.TextView;import com.cody.app.R;import com.cody.app.business.im.ChatActivity;import com.cody.app.databinding.ActivityIntentionBinding;import com.cody.app.databinding.ItemTagBinding;import com.cody.app.framework.activity.ListWithHeaderBaseActivity;import com.cody.app.framework.adapter.BaseRecycleViewAdapter;import com.cody.app.framework.widget.flowlayout.FlowLayout;import com.cody.app.framework.widget.flowlayout.TagAdapter;import com.cody.handler.business.presenter.IntentionCustomerPresenter;import com.cody.handler.business.viewmodel.IntentionCustomerViewModel;import com.cody.handler.business.viewmodel.ItemPotentialCustomerViewModel;import com.cody.handler.business.viewmodel.ItemTagViewModel;import com.cody.handler.framework.viewmodel.HeaderViewModel;import com.cody.handler.framework.viewmodel.ListViewModel;import com.cody.repository.business.bean.SendCouponBean;import com.cody.repository.framework.statistics.BuryingPointUtils;import com.cody.xf.utils.ActivityUtil;import com.cody.xf.utils.ResourceUtil;import com.cody.app.databinding.ItemIntentionCustomerBinding;import com.cody.xf.widget.pullloadmorerecyclerview.PullLoadMoreRecyclerView;/** * 意向客户页面 */public class IntentionCustomerActivity extends ListWithHeaderBaseActivity<IntentionCustomerPresenter,        IntentionCustomerViewModel, ItemPotentialCustomerViewModel, ActivityIntentionBinding> {    private static final String[] tabs = {"全部", "IM咨询", "加购物车", "加心愿单", "领券"};    public static void startIntentionCustomer() {        ActivityUtil.navigateTo(IntentionCustomerActivity.class);    }    @Override    protected void initHeader(HeaderViewModel header) {        header.setVisible(true);        header.setTitle("意向客户");        header.setLeft(true);        header.setLeftResId(R.drawable.xf_ic_back_black);        header.setRightIsText(true);        header.setRightText("发券");        header.setRightColorId(ResourceUtil.getColor(R.color.main_blue));        header.setLineVisible(false);    }    @Override    public void onCreate(Bundle savedInstanceState) {        super.onCreate(savedInstanceState);        for (String tab : tabs) {            TextView tabView = (TextView) LayoutInflater.from(this).inflate(R.layout.tab_filter                    , getBinding().tabLayout, false);            tabView.setText(tab);            getBinding().tabLayout.addTab(getBinding().tabLayout.newTab().setCustomView(tabView));        }        getBinding().tabLayout.addOnTabSelectedListener(new TabLayout.OnTabSelectedListener() {            @Override            public void onTabSelected(TabLayout.Tab tab) {                /**                 * position和FilterType需要对应{@link IntentionCustomerViewModel#FILTER_TYPE_ALL}                 */                //埋点 B端龙果APP意向客户_Tab（全部、IM咨询、加购物车、加心愿单、领券）                if (tabs.length > tab.getPosition()) {                    BuryingPointUtils.build(IntentionCustomerActivity.class, 4243)                            .addTag(tabs[tab.getPosition()]).submitF();                }                if (getViewModel().getFilterType().get() != tab.getPosition()) {                    getViewModel().setFilterType(tab.getPosition());                    onRefresh();                    scrollToTop();                }            }            @Override            public void onTabUnselected(TabLayout.Tab tab) {            }            @Override            public void onTabReselected(TabLayout.Tab tab) {            }        });    }    @Override    protected BaseRecycleViewAdapter<ItemPotentialCustomerViewModel> buildRecycleViewAdapter() {        return new BaseRecycleViewAdapter<ItemPotentialCustomerViewModel>(getViewModel()) {            @Override            public int getItemLayoutId(int viewType) {                return R.layout.item_intention_customer;            }            @Override            public void onBindViewHolder(ViewHolder viewHolder, int position) {                super.onBindViewHolder(viewHolder, position);                ItemIntentionCustomerBinding itemIntentionCustomerBinding                        = (ItemIntentionCustomerBinding) viewHolder.getItemBinding();                ListViewModel<ItemTagViewModel> itemTagViewModels = new ListViewModel<>();                if (getViewModel().get(position).getImFlag()) {                    itemTagViewModels.add(new ItemTagViewModel("IM咨询"));                }                if (getViewModel().get(position).getAddCartFlag()) {                    itemTagViewModels.add(new ItemTagViewModel("加购物车"));                }                if (getViewModel().get(position).getAddWishListFlag()) {                    itemTagViewModels.add(new ItemTagViewModel("加心愿单"));                }                if (getViewModel().get(position).getCouponFlag()) {                    itemTagViewModels.add(new ItemTagViewModel("领券"));                }                if (itemTagViewModels.size() > 0) {                    itemTagViewModels.get(0).setFirstItem(true);                }                itemIntentionCustomerBinding.tagLayout.setAdapter(new TagAdapter<ItemTagViewModel>                        (itemTagViewModels) {                    @Override                    public View getView(FlowLayout parent, int position, ItemTagViewModel item) {                        ItemTagBinding itemAskTagBinding = DataBindingUtil                                .inflate(LayoutInflater.from(IntentionCustomerActivity.this)                                        , R.layout.item_tag,                                        parent, false);                        itemAskTagBinding.setViewModel(item);                        itemAskTagBinding.executePendingBindings();                        return itemAskTagBinding.getRoot();                    }                });            }        };    }    @Override    protected PullLoadMoreRecyclerView buildPullLoadMoreRecyclerView() {        return getBinding().fwList;    }    @Override    protected int getLayoutID() {        return R.layout.activity_intention;    }    @Override    protected IntentionCustomerPresenter buildPresenter() {        return new IntentionCustomerPresenter();    }    @Override    protected IntentionCustomerViewModel buildViewModel(Bundle savedInstanceState) {        IntentionCustomerViewModel viewModel = new IntentionCustomerViewModel();        return viewModel;    }    @Override    public void onItemClick(RecyclerView parent, View view, int position, long id) {        if (getViewModel().getIsSendCoupons().get()) {            getViewModel().get(position).toggleCheck();            if (getViewModel().get(position).getCheck().get()) {                getViewModel().addCheckCount();            } else {                getViewModel().subtractCheckCount();            }        } else if (id == R.id.imageMessage) {//IM咨询            //埋点 B端龙果APP意向客户_IM咨询按钮            BuryingPointUtils.build(IntentionCustomerActivity.class, 4244).submitF();            ChatActivity.startChat(getViewModel().get(position).getImId());        }    }    @Override    public void onClick(View v) {        super.onClick(v);        switch (v.getId()) {            case R.id.headerRightText:                //埋点 B端龙果APP意向客户_发券按钮                BuryingPointUtils.build(IntentionCustomerActivity.class, 4242).submitF();                getViewModel().toggleIsSendCoupons();                if (getViewModel().getIsSendCoupons().get()) {                    getViewModel().getHeaderViewModel().setRightColorId(ResourceUtil.getColor(R.color.gray_333333));                } else {                    getViewModel().getHeaderViewModel().setRightColorId(ResourceUtil.getColor(R.color.main_blue));                }                getPresenter().toggleIsSendCoupon();                break;            case R.id.checkAll:                //埋点 B端龙果APP意向客户发券状态_全选                BuryingPointUtils.build(IntentionCustomerActivity.class, 4245).submitF();                getPresenter().toggleCheckAll();                onRefresh();                break;            case R.id.unSendCoupons:                //埋点 B端龙果APP意向客户发券状态_未发券                BuryingPointUtils.build(IntentionCustomerActivity.class, 4246).submitF();                getPresenter().toggleUnSendCoupon();                onRefresh();                break;            case R.id.confirm:                //埋点 B端龙果APP意向客户发券状态_确认按钮                BuryingPointUtils.build(IntentionCustomerActivity.class, 4247).submitF();                SendCouponBean sendCouponBean = new SendCouponBean();                sendCouponBean.setQueryField(getViewModel().getQueryField());                sendCouponBean.setUserList(getViewModel().getUserListBean());                if (getViewModel().getUncouponCheck().get()) {                    sendCouponBean.setType("1");                }                sendCouponBean.setSelectedUserCount(getViewModel().getCheckCount().get());                CouponsActivity.startCoupons(sendCouponBean                        , getViewModel().getTotalCheck().get()                                || getViewModel().getUncouponCheck().get());                break;        }    }}